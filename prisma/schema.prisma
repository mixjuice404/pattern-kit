generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  email                    String    @unique
  name                     String?
  password                 String
  bio                      String?
  status                   Int       @db.SmallInt
  id                       Int       @id @default(autoincrement())
  avatar_url               String?   @map("avatar_url")
  created_at               DateTime  @default(now()) @map("created_at")
  last_login_at            DateTime? @map("last_login_at")
  updated_at               DateTime  @updatedAt @map("updated_at")
  is_root                  Boolean   @default(false) @map("is_root")
  mobile                   String?   @unique
  refresh_token            String?   @map("refresh_token")
  last_ip                  String?   @map("last_ip")
  refresh_token_expires_at DateTime? @map("refresh_token_expires_at")
  user_id                  String    @unique @default(cuid())
  deleted                  BigInt    @default(0)
  version                  Int       @default(1)

  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)
  version     Int      @default(1)

  @@map("roles")
}

model UserRoleRelation {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  roleId     Int      @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  created_at DateTime @default(now()) @map("created_at")
  deleted    BigInt   @default(0)
  updated_at DateTime @updatedAt @map("updated_at")
  version    Int      @default(1)

  @@map("user_role_relation")
}

model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  group       String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)
  version     Int      @default(1)

  @@map("permissions")
}

model CrochetPattern {
  id           Int      @id @default(autoincrement())
  title        String   @unique
  cover_image  String?
  description  String?
  pattern_json Json?
  version      Int      @default(1)
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")
  deleted      BigInt   @default(0)

  @@map("crochet_pattern")
}

// 增加一个 管理 prompt 模板的表
model PromptTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  alias       String   @default("")
  template    String
  description String?
  version     Int      @default(1)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)

  @@map("prompt_template")
}


// 钩织针法管理
// schema.prisma

// 针法主表 (Stitch)
// 存储不随语言变化的核心属性
model Stitch {
  id        Int      @id @default(autoincrement()) // 使用自增整数作为唯一标识
  // 核心属性
  defaultName String  // 这里的 defaultName 作为一个兜底显示，万一找不到翻译时使用
  description String? // 针法描述
  type  String // 针法类型
  level String // 难度等级
  version     Int      @default(1)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)

  localizations StitchLocalization[] // 添加这一行

  @@map("stitches") // 映射到数据库中的表名为 stitches
}

// 针法多语言翻译表 (StitchLocalization)
// 存储随语言变化的文本内容
model StitchLocalization {
  id        Int      @id @default(autoincrement()) // 使用自增整数作为唯一标识
  // 外键关联
  stitchId Int
  stitch   Stitch @relation(fields: [stitchId], references: [id], onDelete: Cascade)

  // 语言代码，例如 "zh", "en", "jp"
  languageCode String

  // 文本内容
  name        String // 针法名称 (当前语言)
  abbrev      String? // 针法缩写 (有的语言可能没有，设为可选)
  description String  @db.Text // 详细描述，使用 Text 类型以支持长文本
  version     Int      @default(1)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)

  // 复合唯一索引：确保同一个针法在同一种语言下只有一条翻译记录
  @@unique([stitchId, languageCode])
  @@map("stitch_localizations") // 映射到数据库表名为 stitch_localizations
}

// 针法语言支持表
// 存储语言相关信息
model StitchLanguage {
  id        String   @id @default(uuid())
  code      String   @unique // 语言代码，例如 "zh", "en", "jp"
  name      String   // 语言名称，例如 "中文", "英文", "日文"
  flag      String   // 语言标志，例如 "zh", "en", "jp"
  version     Int      @default(1)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted     BigInt   @default(0)

  @@map("stitch_languages") // 映射到数据库表名为 stitch_languages
}


// Pattern workflow data
model PatternDraft {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  raw_content     String?  @db.Text
  revised_content String?  @db.Text
  result_content  String?  @db.Text
  info            Json?
  meta            Json?
  report          Json?
  stitches        Json?
  supplies        Json?
  status          String   @default("pending")
  state           Int      @default(0)
  version         Int      @default(1)
  created_at      DateTime @default(now()) @map("created_at")
  updated_at      DateTime @updatedAt @map("updated_at")
  deleted         BigInt   @default(0)

  @@map("pattern_drafts")
}

